<!DOCTYPE html>
<html lang="zh-VN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard HSK - Learn Chinese</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://unpkg.com/antd@5.12.8/dist/reset.css">
    
    <!-- Ant Design JS -->
    <script src="https://unpkg.com/antd@5.12.8/dist/antd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-layer-group"></i>
                <span>Flashcard HSK</span>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-value" id="cards-learned">0</span>
                    <span class="stat-label">Learned</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="streak-days">1</span>
                    <span class="stat-label">Day Streak</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
        <!-- React Settings Bar -->
        <div id="react-settings-bar"></div>

        <!-- Card Container -->
        <div class="card-stack-container">
            <div class="card-stack" id="cardStack">
                <!-- Cards will be dynamically generated here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn recall-btn" id="recall-button">
                <i class="fas fa-undo"></i>
                <span>Recall</span>
            </button>
            <button class="action-btn flip-btn" id="flip-button">
                <i class="fas fa-sync-alt"></i>
                <span>Flip</span>
            </button>
            <button class="action-btn remembered-btn" id="remembered-button">
                <i class="fas fa-check"></i>
                <span>Remembered</span>
            </button>
        </div>
    </main>

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Splash Screen -->
    <div class="splash-screen" id="splash-screen">
        <div class="splash-content">
            <div class="splash-icon"></div>
            <div class="splash-text"></div>
        </div>
    </div>

    <!-- No More Cards Screen -->
    <div class="no-more-cards" id="noMoreCards" style="display: none;">
        <div class="no-more-content">
            <i class="fas fa-trophy"></i>
            <h2>Great Job!</h2>
            <p>You've reviewed all cards for this session</p>
            <button class="restart-btn" id="restartBtn">
                <i class="fas fa-redo"></i>
                Start New Session
            </button>
        </div>
    </div>
    <script src="flashcard.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/flashcard/sw.js', {
                    scope: '/flashcard/'
                })
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the default mini-infobar from appearing on mobile
            e.preventDefault();
            // Store the event for later use
            deferredPrompt = e;
            // Show the install button
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    // Clear the deferred prompt
                    deferredPrompt = null;
                    // Hide the install button
                    installButton.style.display = 'none';
                });
            }
        });

        // Detect when the app is installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installButton.style.display = 'none';
        });
    </script>

    <!-- React Settings Bar Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Select, Switch, Card, Space, Typography, Button, Dropdown, Menu } = antd;
        const { Title, Text } = Typography;

        // HSK Level Selector Component
        function HSKLevelSelector({ value, onChange }) {
            const handleHskChange = (e) => {
                const newValue = e.target.value;
                console.log('HSK Level changed to:', newValue);
                onChange(newValue);
            };

            return (
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <i className="fas fa-graduation-cap"></i>
                    <span style={{ fontWeight: '500' }}>HSK Level</span>
                    <select 
                        value={value} 
                        onChange={handleHskChange}
                        style={{ 
                            padding: '4px 8px', 
                            borderRadius: '4px', 
                            border: 'none',
                            background: 'rgba(255,255,255,0.9)',
                            color: '#333'
                        }}
                    >
                        <option value="hsk3">ðŸ“š HSK 3</option>
                        <option value="hsk4">ðŸ“– HSK 4</option>
                    </select>
                </div>
            );
        }

        // Language Toggle Component
        function LanguageToggle({ isChineseFirst, onChange }) {
            const handleLanguageChange = (e) => {
                const checked = e.target.checked;
                console.log('Language mode changed to:', checked ? 'Chinese First' : 'Vietnamese First');
                onChange(checked);
            };

            return (
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <i className="fas fa-language"></i>
                    <span style={{ fontWeight: '500' }}>Language Mode</span>
                    <label style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '8px',
                        cursor: 'pointer'
                    }}>
                        <input 
                            type="checkbox" 
                            checked={isChineseFirst} 
                            onChange={handleLanguageChange}
                            style={{ display: 'none' }}
                        />
                        <div style={{
                            width: '50px',
                            height: '24px',
                            background: isChineseFirst ? '#52c41a' : '#1894d6',
                            borderRadius: '12px',
                            position: 'relative',
                            transition: 'background 0.3s'
                        }}>
                            <div style={{
                                position: 'absolute',
                                top: '2px',
                                left: isChineseFirst ? '26px' : '2px',
                                width: '20px',
                                height: '20px',
                                background: 'white',
                                borderRadius: '50%',
                                transition: 'left 0.3s'
                            }}></div>
                        </div>
                        <span style={{ fontSize: '12px' }}>
                            {isChineseFirst ? 'ä¸­æ–‡' : 'Tiáº¿ng Viá»‡t'}
                        </span>
                    </label>
                </div>
            );
        }

        // Action Buttons Component
        function ActionButtons() {
            const handleProgressClick = () => {
                const progressEvent = new CustomEvent('showProgress', { detail: {} });
                window.dispatchEvent(progressEvent);
            };

            const handleResetClick = () => {
                if (confirm('Are you sure you want to reset your progress?')) {
                    window.dispatchEvent(new CustomEvent('resetProgress', { detail: {} }));
                }
            };

            return (
                <div style={{ display: 'flex', gap: '10px' }}>
                    <button 
                        onClick={handleProgressClick}
                        style={{ 
                            background: 'transparent', 
                            color: 'white', 
                            border: 'none',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '5px',
                            padding: '8px'
                        }}
                    >
                        <i className="fas fa-chart-line"></i>
                        Progress
                    </button>
                    <button 
                        onClick={handleResetClick}
                        style={{ 
                            background: 'transparent', 
                            color: 'white', 
                            border: 'none',
                            cursor: 'pointer',
                            padding: '8px'
                        }}
                    >
                        <i className="fas fa-redo"></i>
                    </button>
                </div>
            );
        }

        // Instructions Component
        function Instructions() {
            return (
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'center', 
                    gap: '16px',
                    padding: '8px 0',
                    borderTop: '1px solid rgba(255,255,255,0.2)',
                    marginTop: '12px',
                    fontSize: '12px',
                    opacity: 0.8,
                    flexWrap: 'wrap'
                }}>
                    <span>
                        <i className="fas fa-undo"></i> Swipe Left: Recall
                    </span>
                    <span>
                        <i className="fas fa-check"></i> Swipe Right: Remembered
                    </span>
                    <span>
                        <i className="fas fa-sync"></i> Click: Flip Card
                    </span>
                </div>
            );
        }

        // Main Settings Bar Component
        function SettingsBar({ onSettingsChange }) {
            const [hskLevel, setHskLevel] = React.useState('hsk3');
            const [isChineseFirst, setIsChineseFirst] = React.useState(true);

            // Notify parent component of settings changes
            React.useEffect(() => {
                if (onSettingsChange) {
                    onSettingsChange({ hskLevel, isChineseFirst });
                }
            }, [hskLevel, isChineseFirst, onSettingsChange]);

            const handleHskLevelChange = (newLevel) => {
                setHskLevel(newLevel);
            };

            const handleLanguageChange = (newLanguageState) => {
                setIsChineseFirst(newLanguageState);
            };

            return (
                <div 
                    className="react-settings-bar"
                    style={{ 
                        margin: '16px', 
                        borderRadius: '12px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        padding: '16px',
                        color: 'white'
                    }}
                >
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap' }}>
                        <div style={{ display: 'flex', gap: '20px', alignItems: 'center', flexWrap: 'wrap' }}>
                            <HSKLevelSelector 
                                value={hskLevel} 
                                onChange={handleHskLevelChange} 
                            />
                            <LanguageToggle 
                                isChineseFirst={isChineseFirst} 
                                onChange={handleLanguageChange} 
                            />
                        </div>
                        
                        <ActionButtons />
                    </div>
                    
                    <Instructions />
                </div>
            );
        }

        // Initialize React Settings Bar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing React settings bar...');
            
            const settingsContainer = document.getElementById('react-settings-bar');
            console.log('Settings container found:', settingsContainer);
            
            if (settingsContainer) {
                try {
                    // Check if React and Ant Design are loaded
                    console.log('React available:', typeof React !== 'undefined');
                    console.log('ReactDOM available:', typeof ReactDOM !== 'undefined');
                    console.log('Ant Design available:', typeof antd !== 'undefined');
                    
                    const root = ReactDOM.createRoot(settingsContainer);
                    
                    // Expose settings change handler to global scope for communication with vanilla JS
                    window.onReactSettingsChange = (settings) => {
                        console.log('Settings changed:', settings);
                        // Trigger custom event for vanilla JS to listen to
                        window.dispatchEvent(new CustomEvent('settingsChanged', { detail: settings }));
                    };
                    
                    console.log('Rendering React SettingsBar component...');
                    root.render(<SettingsBar onSettingsChange={window.onReactSettingsChange} />);
                    console.log('React SettingsBar rendered successfully!');
                } catch (error) {
                    console.error('Error rendering React settings bar:', error);
                    // Fallback: show a simple settings bar if React fails
                    settingsContainer.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 12px; margin: 16px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; gap: 20px; align-items: center;">
                                    <div>
                                        <label style="margin-right: 10px;">HSK Level:</label>
                                        <select id="fallback-hsk-level" style="padding: 4px 8px; border-radius: 4px; border: none;">
                                            <option value="hsk3">HSK 3</option>
                                            <option value="hsk4">HSK 4</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="margin-right: 10px;">Language:</label>
                                        <select id="fallback-language" style="padding: 4px 8px; border-radius: 4px; border: none;">
                                            <option value="chinese">Chinese First</option>
                                            <option value="vietnamese">Vietnamese First</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add fallback event listeners
                    document.getElementById('fallback-hsk-level').addEventListener('change', (e) => {
                        window.dispatchEvent(new CustomEvent('settingsChanged', { 
                            detail: { 
                                hskLevel: e.target.value, 
                                isChineseFirst: document.getElementById('fallback-language').value === 'chinese' 
                            } 
                        }));
                    });
                    
                    document.getElementById('fallback-language').addEventListener('change', (e) => {
                        window.dispatchEvent(new CustomEvent('settingsChanged', { 
                            detail: { 
                                hskLevel: document.getElementById('fallback-hsk-level').value, 
                                isChineseFirst: e.target.value === 'chinese' 
                            } 
                        }));
                    });
                }
            } else {
                console.error('Settings container not found!');
            }
        });
    </script>

</body>

</html>